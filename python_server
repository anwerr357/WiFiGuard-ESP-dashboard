from flask import Flask, request, jsonify, render_template_string
from datetime import datetime
from collections import defaultdict, deque
import time

app = Flask(__name__)

# ==================== STOCKAGE DES DONN√âES ====================
scan_history = []
devices_database = {}
alerts = []
attack_stats = defaultdict(int)

# ‚ú® Historique pour les graphiques
alert_history = deque(maxlen=50)
device_count_history = deque(maxlen=50)

# ‚ú® Stats DDoS en temps r√©el
last_ddos_stats = {
    'total_packets': 0,
    'packets_per_sec': 0,
    'capture_time': 'N/A'
}

# Configuration
TRUSTED_IPS = [
    
    '192.168.1.179',  # ESP8266
]

TRUSTED_MACS = []

WHITELIST = []
BLACKLIST = ['40:D1:60:58:AE:D7']
MAX_HISTORY = 100

# ==================== CLASSE DE D√âTECTION ====================
class AttackDetector:
    def __init__(self):
        self.previous_scan = {}
        self.mac_ip_history = defaultdict(list)
        self.ip_mac_history = defaultdict(list)
        self.gateway_mac = None
        
        # Pour DDoS
        self.connection_rate = defaultdict(lambda: deque(maxlen=10))
        self.packet_count = defaultdict(int)
        self.scan_timestamps = defaultdict(list)
        
        # Pour Nmap
        self.port_scan_history = defaultdict(lambda: {'ports': set(), 'scan_count': 0, 'last_scan': 0})
        self.rapid_port_changes = defaultdict(int)
        
    def analyze(self, scan_data):
        """Analyse un scan et d√©tecte les attaques"""
        threats = []
        current_devices = scan_data.get('devices', [])
        esp_ip = scan_data.get('esp_ip', '')
        scan_duration = scan_data.get('scan_duration', 0)
        scan_timestamp = scan_data.get('timestamp_ms', time.time() * 1000)
        
        network = '.'.join(esp_ip.split('.')[:3])
        gateway_ip = f"{network}.1"
        
        for device in current_devices:
            ip = device.get('ip', '')
            mac = device.get('mac', '').upper()
            is_trusted = ip in TRUSTED_IPS or mac in TRUSTED_MACS
            device_type = device.get('type', 'U')
            open_ports = device.get('open_ports', [])
            open_port_count = device.get('open_port_count', 0)
            
            # D√©tections de base
            threats.extend(self.detect_arp_spoofing(ip, mac))
            threats.extend(self.detect_mac_spoofing(ip, mac))
            
            if ip == gateway_ip:
                threats.extend(self.detect_gateway_spoofing(mac))
            
            threats.extend(self.detect_unauthorized_device(mac))
            threats.extend(self.detect_blacklisted_device(mac, ip))
            
            # Nmap et DDoS (appareils non de confiance seulement)
            if not is_trusted:
                threats.extend(self.detect_nmap_scan(ip, mac, open_ports, open_port_count))
                threats.extend(self.detect_ddos_activity(ip, mac, scan_timestamp, scan_duration))
            else:
                print(f"‚ÑπÔ∏è  Appareil de confiance ignor√©: {ip} ({mac})")
            
            self.update_history(ip, mac, open_ports, scan_timestamp)
        
        # D√©tections globales
        threats.extend(self.detect_disappeared_devices(current_devices))
        
        # Exclure IPs de confiance du DDoS distribu√©
        current_devices_untrusted = [
            d for d in current_devices 
            if d.get('ip') not in TRUSTED_IPS and d.get('mac', '').upper() not in TRUSTED_MACS
        ]
        threats.extend(self.detect_distributed_ddos(current_devices_untrusted))
        
        self.previous_scan = {d['ip']: d for d in current_devices}
        
        return threats
    
    # ==================== D√âTECTION NMAP ====================
    def detect_nmap_scan(self, ip, mac, open_ports, open_port_count):
        """D√©tecte les scans Nmap"""
        threats = []
        current_time = time.time()
        
        port_history = self.port_scan_history[ip]
        previous_ports = port_history['ports']
        current_ports = set(open_ports)
        
        if open_port_count > 15:
            threats.append({
                'type': 'NMAP_SUSPICIOUS_PORTS',
                'severity': 'HIGH',
                'ip': ip,
                'mac': mac,
                'description': f'üîç Scan Nmap d√©tect√©! {ip} a {open_port_count} ports ouverts',
                'details': f'Ports: {", ".join(map(str, open_ports[:10]))}{"..." if len(open_ports) > 10 else ""}',
                'recommendation': 'Nombre anormal de ports. V√©rifiez cet appareil.'
            })
        
        new_ports = current_ports - previous_ports
        closed_ports = previous_ports - current_ports
        
        if len(new_ports) > 10 or len(closed_ports) > 10:
            self.rapid_port_changes[ip] += 1
            
            if self.rapid_port_changes[ip] >= 2:
                threats.append({
                    'type': 'NMAP_ACTIVE_SCAN',
                    'severity': 'CRITICAL',
                    'ip': ip,
                    'mac': mac,
                    'description': f'üö® Scan Nmap ACTIF depuis {ip}!',
                    'details': f'Nouveaux ports: {len(new_ports)} | Ferm√©s: {len(closed_ports)}',
                    'recommendation': 'Scan actif en cours! Isolez cet appareil.'
                })
                self.rapid_port_changes[ip] = 0
        
        if len(open_ports) >= 5:
            sorted_ports = sorted(open_ports)
            consecutive_count = 0
            for i in range(len(sorted_ports) - 1):
                if sorted_ports[i+1] - sorted_ports[i] <= 2:
                    consecutive_count += 1
            
            if consecutive_count >= 5:
                threats.append({
                    'type': 'NMAP_SEQUENTIAL_SCAN',
                    'severity': 'HIGH',
                    'ip': ip,
                    'mac': mac,
                    'description': f'‚ö†Ô∏è Pattern Nmap: Scan s√©quentiel depuis {ip}',
                    'details': f'Ports cons√©cutifs: {sorted_ports[:10]}',
                    'recommendation': 'Scan s√©quentiel typique de nmap -p-'
                })
        
        port_history['scan_count'] += 1
        time_since_last = current_time - port_history['last_scan']
        
        if port_history['scan_count'] > 10 and time_since_last < 120:
            threats.append({
                'type': 'NMAP_REPEATED_SCAN',
                'severity': 'MEDIUM',
                'ip': ip,
                'mac': mac,
                'description': f'üîÑ Scans r√©p√©t√©s depuis {ip}',
                'details': f'{port_history["scan_count"]} scans en {int(time_since_last)}s',
                'recommendation': 'Scans tr√®s fr√©quents. Possiblement un outil automatis√©.'
            })
            port_history['scan_count'] = 0
        
        port_history['ports'] = current_ports
        port_history['last_scan'] = current_time
        
        return threats
    
    # ==================== D√âTECTION DDoS ====================
    def detect_ddos_activity(self, ip, mac, scan_timestamp, scan_duration):
        """D√©tecte les activit√©s DDoS"""
        threats = []
        
        self.scan_timestamps[ip].append(scan_timestamp)
        
        if len(self.scan_timestamps[ip]) > 20:
            self.scan_timestamps[ip].pop(0)
        
        elif len(self.scan_timestamps[ip]) >= 15:
            recent_scans = self.scan_timestamps[ip][-15:]
            time_range = recent_scans[-1] - recent_scans[0]
            
            if time_range < 300000:
                scan_frequency = len(recent_scans) / (time_range / 60000)
                
                if scan_frequency > 5.0:
                    threats.append({
                        'type': 'DDOS_HIGH_FREQUENCY',
                        'severity': 'HIGH',
                        'ip': ip,
                        'mac': mac,
                        'description': f'‚ö†Ô∏è DDoS potentiel: {ip} d√©tect√© {scan_frequency:.1f} fois/min',
                        'details': f'Fr√©quence anormale: {scan_frequency:.2f} d√©tections/min',
                        'recommendation': 'Trafic excessif. V√©rifiez si cet appareil est compromis.'
                    })
        
        if scan_duration > 0 and scan_duration < 2000:
            self.packet_count[ip] += 1
            
            if self.packet_count[ip] > 15:
                threats.append({
                    'type': 'DDOS_RAPID_ACTIVITY',
                    'severity': 'MEDIUM',
                    'ip': ip,
                    'mac': mac,
                    'description': f'üî• Activit√© r√©seau ultra-rapide depuis {ip}',
                    'details': f'15+ connexions ultra-rapides (< 2s)',
                    'recommendation': 'Possible SYN flood ou botnet. Surveillez cet appareil.'
                })
                self.packet_count[ip] = 0
        
        return threats
    
    def detect_distributed_ddos(self, current_devices):
        """D√©tecte les attaques DDoS distribu√©es"""
        threats = []
        
        suspicious_ips = []
        
        for device in current_devices:
            ip = device.get('ip', '')
            open_port_count = device.get('open_port_count', 0)
            
            if open_port_count > 5:
                suspicious_ips.append(ip)
        
        if len(suspicious_ips) >= 3:
            threats.append({
                'type': 'DDOS_DISTRIBUTED',
                'severity': 'CRITICAL',
                'description': f'üö® ATTAQUE DDoS DISTRIBU√âE D√âTECT√âE!',
                'details': f'{len(suspicious_ips)} appareils avec activit√© anormale simultan√©e',
                'devices': suspicious_ips,
                'recommendation': 'ALERTE: Possible botnet ou DDoS distribu√©. Isolez ces appareils!'
            })
        
        return threats
    
    # ==================== D√âTECTIONS DE BASE ====================
    def detect_arp_spoofing(self, ip, mac):
        threats = []
        if ip in self.ip_mac_history:
            previous_macs = self.ip_mac_history[ip]
            if mac not in previous_macs and len(previous_macs) > 0:
                threats.append({
                    'type': 'ARP_SPOOFING',
                    'severity': 'CRITICAL',
                    'ip': ip,
                    'mac': mac,
                    'description': f'üö® ARP Spoofing d√©tect√©! IP {ip} a chang√© de MAC: {previous_macs[-1]} ‚Üí {mac}',
                    'recommendation': 'V√©rifier les appareils connect√©s. Possible attaque MITM.'
                })
        return threats
    
    def detect_mac_spoofing(self, ip, mac):
        threats = []
        if mac in self.mac_ip_history:
            previous_ips = self.mac_ip_history[mac]
            if ip not in previous_ips and len(previous_ips) > 0:
                threats.append({
                    'type': 'MAC_SPOOFING',
                    'severity': 'HIGH',
                    'ip': ip,
                    'mac': mac,
                    'description': f'‚ö†Ô∏è MAC Spoofing possible! MAC {mac} d√©tect√©e sur plusieurs IPs: {previous_ips[-1]} et {ip}',
                    'recommendation': 'V√©rifier si c\'est un appareil l√©gitime avec DHCP.'
                })
        return threats
    
    def detect_gateway_spoofing(self, mac):
        threats = []
        if self.gateway_mac is None:
            self.gateway_mac = mac
        elif self.gateway_mac != mac:
            threats.append({
                'type': 'MITM_GATEWAY',
                'severity': 'CRITICAL',
                'mac': mac,
                'description': f'üî¥ ATTAQUE MITM! Gateway a chang√© de MAC: {self.gateway_mac} ‚Üí {mac}',
                'recommendation': 'DANGER! Possible Man-in-the-Middle. D√©connectez-vous imm√©diatement!'
            })
            self.gateway_mac = mac
        return threats
    
    def detect_unauthorized_device(self, mac):
        threats = []
        if len(WHITELIST) > 0 and mac not in WHITELIST:
            threats.append({
                'type': 'UNAUTHORIZED_DEVICE',
                'severity': 'MEDIUM',
                'mac': mac,
                'description': f'‚ö° Appareil non autoris√© d√©tect√©: {mac}',
                'recommendation': 'V√©rifier si cet appareil devrait √™tre sur le r√©seau.'
            })
        return threats
    
    def detect_blacklisted_device(self, mac, ip):
        threats = []
        if ip in BLACKLIST:
            threats.append({
                'type': 'BLACKLISTED_DEVICE',
                'severity': 'CRITICAL',
                'mac': mac,
                'ip': ip,
                'description': f'üö´ Appareil blacklist√© connect√©! IP: {ip}',
                'recommendation': 'Bloquer imm√©diatement cet appareil sur le routeur.'
            })
        return threats
    
    def detect_disappeared_devices(self, current_devices):
        threats = []
        current_ips = {d['ip'] for d in current_devices}
        previous_ips = set(self.previous_scan.keys())
        disappeared = previous_ips - current_ips
        
        if len(disappeared) >= 3:
            threats.append({
                'type': 'DEAUTH_ATTACK',
                'severity': 'HIGH',
                'description': f'‚ö†Ô∏è D√©authentication Attack possible! {len(disappeared)} appareils d√©connect√©s simultan√©ment',
                'devices': list(disappeared),
                'recommendation': 'Possible attaque de d√©authentification WiFi. V√©rifier le routeur.'
            })
        return threats
    
    def update_history(self, ip, mac, open_ports=None, timestamp=None):
        if mac not in self.mac_ip_history[mac]:
            self.mac_ip_history[mac].append(ip)
            if len(self.mac_ip_history[mac]) > 5:
                self.mac_ip_history[mac].pop(0)
        
        if ip not in self.ip_mac_history[ip]:
            self.ip_mac_history[ip].append(mac)
            if len(self.ip_mac_history[ip]) > 5:
                self.ip_mac_history[ip].pop(0)

# Instance du d√©tecteur
detector = AttackDetector()

# ==================== API ENDPOINTS ====================
@app.route('/scan', methods=['POST'])
def receive_scan():
    """Re√ßoit les donn√©es de scan depuis l'ESP8266 + Sniffer DDoS"""
    try:
        global last_ddos_stats
        
        data = request.get_json()
        
        # Timestamp
        data['timestamp'] = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        
        timestamp_value = data.get('timestamp', time.time() * 1000)
        if isinstance(timestamp_value, str):
            try:
                timestamp_value = float(timestamp_value)
            except (ValueError, TypeError):
                timestamp_value = time.time() * 1000
        
        data['timestamp_ms'] = int(timestamp_value) if timestamp_value > 1000000000000 else int(timestamp_value * 1000)
        
        # ‚ú® Extraire les donn√©es DDoS du sniffer
        ddos_data = data.get('ddos_detection', {})
        total_packets = ddos_data.get('total_packets', 0)
        packets_per_sec = ddos_data.get('packets_per_sec', 0)
        top_sources = ddos_data.get('top_sources', [])
        
        # ‚ú® STOCKER dans la variable globale
        last_ddos_stats = {
            'total_packets': total_packets,
            'packets_per_sec': packets_per_sec,
            'capture_time': data['timestamp']
        }
        
        print(f"\n{'='*60}")
        print(f"üì° SCAN RE√áU - {data['timestamp']}")
        print(f"{'='*60}")
        print(f"üìä Appareils d√©tect√©s: {len(data.get('devices', []))}")
        print(f"üî• Paquets WiFi captur√©s: {total_packets}")
        print(f"üìà D√©bit r√©seau: {packets_per_sec} paquets/sec")
        
        # ‚ú® Analyser le trafic r√©seau (SEUILS R√âDUITS POUR TEST)
        ddos_threats = []
        
        # SEUIL 1: Flood massif (> 10k)
        if total_packets > 10000:
            ddos_threats.append({
                'type': 'DDOS_NETWORK_FLOOD',
                'severity': 'CRITICAL',
                'description': f'üö® FLOOD MASSIF D√âTECT√â!',
                'details': f'Trafic anormal: {total_packets:,} paquets en 20s ({packets_per_sec:,} pkt/s)',
                'recommendation': 'ALERTE CRITIQUE! Attaque DDoS en cours.',
                'timestamp': data['timestamp']
            })
            print(f"üö® ALERTE CRITIQUE: FLOOD MASSIF - {total_packets:,} paquets!")
        
        # SEUIL 2: Trafic √©lev√© (> 5k)
        elif total_packets > 5000:
            ddos_threats.append({
                'type': 'DDOS_HIGH_TRAFFIC',
                'severity': 'HIGH',
                'description': f'‚ö†Ô∏è Trafic r√©seau √©lev√©',
                'details': f'Activit√© suspecte: {total_packets:,} paquets ({packets_per_sec:,} pkt/s)',
                'recommendation': 'Trafic anormalement √©lev√©. Surveillez le r√©seau.',
                'timestamp': data['timestamp']
            })
            print(f"‚ö†Ô∏è ALERTE: Trafic √©lev√© - {total_packets:,} paquets")
        
        # SEUIL 3: Trafic mod√©r√© (> 1k)
        elif total_packets > 1000:
            ddos_threats.append({
                'type': 'DDOS_MODERATE_TRAFFIC',
                'severity': 'HIGH',
                'description': f'‚ÑπÔ∏è Trafic r√©seau mod√©r√©',
                'details': f'Activit√©: {total_packets:,} paquets ({packets_per_sec:,} pkt/s)',
                'recommendation': 'Trafic l√©g√®rement √©lev√©. Continuez la surveillance.',
                'timestamp': data['timestamp']
            })
            print(f"‚ÑπÔ∏è INFO: Trafic mod√©r√© - {total_packets:,} paquets")
        else:
            print(f"‚úÖ Trafic normal: {total_packets} paquets")
        
        # Analyser les sources
        if len(top_sources) > 0:
            print(f"\nüìä Top sources de trafic WiFi:")
            
            for i, source in enumerate(top_sources[:5], 1):
                mac_suffix = source.get('mac_suffix', 0)
                packet_count = source.get('packet_count', 0)
                
                if total_packets > 0:
                    percentage = (packet_count * 100) / total_packets
                else:
                    percentage = 0
                
                print(f"   #{i} MAC ...{mac_suffix:02X}: {packet_count:,} paquets ({percentage:.1f}%)")
                
                # Si une source g√©n√®re > 40% = suspect
                if percentage > 40 and total_packets > 1000:
                    ddos_threats.append({
                        'type': 'DDOS_SINGLE_SOURCE',
                        'severity': 'HIGH',
                        'mac': f'XX:XX:XX:XX:XX:{mac_suffix:02X}',
                        'description': f'‚ö†Ô∏è Source unique dominante',
                        'details': f'MAC ...{mac_suffix:02X}: {packet_count:,} paquets ({percentage:.1f}%)',
                        'recommendation': 'Une source g√©n√®re la majorit√© du trafic.',
                        'timestamp': data['timestamp']
                    })
                    print(f"   üö® SUSPECT: Source ...{mac_suffix:02X} domine!")
        
        # Ajouter les alertes DDoS
        for threat in ddos_threats:
            alerts.append(threat)
            attack_stats[threat['type']] += 1
        
        # Analyser les menaces normales
        threats = detector.analyze(data)
        
        for threat in threats:
            threat['timestamp'] = data['timestamp']
            alerts.append(threat)
            attack_stats[threat['type']] += 1
        
        if len(alerts) > 200:
            alerts[:] = alerts[-200:]
        
        # Historique graphique
        critical_alerts = len([t for t in threats + ddos_threats if t['severity'] in ['CRITICAL', 'HIGH']])
        
        alert_history.append({
            'timestamp': data['timestamp'],
            'count': critical_alerts
        })
        
        device_count_history.append({
            'timestamp': data['timestamp'],
            'count': len(data.get('devices', []))
        })
        
        # Stocker
        scan_history.append(data)
        if len(scan_history) > MAX_HISTORY:
            scan_history.pop(0)
        
        # Database
        for device in data.get('devices', []):
            mac = device.get('mac', '').upper()
            if mac:
                if mac not in devices_database:
                    devices_database[mac] = {
                        'first_seen': data['timestamp'],
                        'ips': [],
                        'type': device.get('type', 'U'),
                        'open_ports': []
                    }
                
                ip = device.get('ip', '')
                if ip and ip not in devices_database[mac]['ips']:
                    devices_database[mac]['ips'].append(ip)
                
                open_ports = device.get('open_ports', [])
                devices_database[mac]['open_ports'] = open_ports
        
        total_threats = len(threats) + len(ddos_threats)
        
        response = {
            'status': 'success',
            'devices_received': len(data.get('devices', [])),
            'threats_detected': total_threats,
            'ddos_packets': total_packets,
            'ddos_threats': len(ddos_threats)
        }
        
        print(f"\n‚úÖ Menaces totales: {total_threats}")
        print(f"   - DDoS: {len(ddos_threats)}")
        print(f"   - Autres: {len(threats)}")
        print(f"{'='*60}\n")
        
        return jsonify(response), 200
        
    except Exception as e:
        import traceback
        print(f"‚ùå Erreur: {str(e)}")
        print(traceback.format_exc())
        return jsonify({'status': 'error', 'message': str(e)}), 400

@app.route('/api/activity')
def get_activity():
    """Retourne l'historique pour le graphique"""
    return jsonify({
        'alerts': list(alert_history),
        'devices': list(device_count_history)
    })

@app.route('/')
def dashboard():
    """Interface web principale"""
    global last_ddos_stats
    
    # ‚úÖ Utiliser les donn√©es DDoS stock√©es
    network_packets = last_ddos_stats.get('total_packets', 0)
    packets_per_sec = last_ddos_stats.get('packets_per_sec', 0)
    
    html = """
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>WiFi Security Monitor</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
                font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 25%, #0f3460 50%, #533483 100%);
                color: #fff;
                padding: 20px;
                min-height: 100vh;
                position: relative;
            }
            body::before {
                content: "";
                position: fixed;
                top: 0; left: 0;
                width: 100%; height: 100%;
                background-image: 
                    radial-gradient(circle at 20% 30%, rgba(239, 83, 80, 0.08) 0%, transparent 50%),
                    radial-gradient(circle at 80% 70%, rgba(244, 67, 54, 0.06) 0%, transparent 50%);
                pointer-events: none;
                z-index: 0;
                animation: gradientShift 15s ease infinite;
            }
            @keyframes gradientShift {
                0%, 100% { opacity: 0.6; }
                50% { opacity: 1; }
            }
            .container {
                max-width: 1800px;
                margin: 0 auto;
                position: relative;
                z-index: 1;
            }
            .header {
                text-align: center;
                margin-bottom: 30px;
                padding: 30px;
                background: linear-gradient(135deg, rgba(30, 30, 50, 0.95), rgba(20, 20, 40, 0.9));
                border-radius: 12px;
                backdrop-filter: blur(15px);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
                border: 1px solid rgba(239, 83, 80, 0.2);
            }
            .main-title {
                font-size: 2.5em;
                font-weight: 700;
                margin-bottom: 15px;
                background: linear-gradient(135deg, #ef5350, #ff6f00, #ff1744);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                letter-spacing: -0.5px;
            }
            .detection-list {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
                margin-top: 15px;
            }
            .detection-badge {
                padding: 6px 14px;
                background: rgba(239, 83, 80, 0.15);
                border: 1px solid rgba(239, 83, 80, 0.3);
                border-radius: 20px;
                font-size: 0.75em;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                color: #ffccbc;
                transition: all 0.3s;
            }
            .detection-badge:hover {
                background: rgba(239, 83, 80, 0.25);
                border-color: rgba(239, 83, 80, 0.5);
                transform: translateY(-2px);
            }
            .stats-grid {
                display: grid;
                grid-template-columns: repeat(6, minmax(0, 1fr));
                gap: 15px;
                margin-bottom: 30px;
            }
            .stat-card {
                background: linear-gradient(135deg, rgba(30, 30, 50, 0.95), rgba(20, 20, 40, 0.9));
                padding: 20px;
                border-radius: 10px;
                border: 1px solid rgba(239, 83, 80, 0.2);
                backdrop-filter: blur(10px);
                text-align: center;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                position: relative;
                overflow: hidden;
            }
            .stat-card::before {
                content: "";
                position: absolute;
                top: 0; left: -100%;
                width: 100%; height: 2px;
                background: linear-gradient(90deg, transparent, #ef5350, transparent);
                transition: left 0.5s;
            }
            .stat-card:hover::before { left: 100%; }
            .stat-card:hover {
                transform: translateY(-5px);
                border-color: rgba(239, 83, 80, 0.5);
                box-shadow: 0 8px 25px rgba(239, 83, 80, 0.3);
            }
            .stat-label {
                color: #b0bec5;
                font-size: 0.75em;
                text-transform: uppercase;
                letter-spacing: 1px;
                font-weight: 700;
                margin-bottom: 12px;
            }
            .stat-number {
                font-size: 2.8em;
                font-weight: 800;
                margin: 10px 0;
                line-height: 1;
                font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            }
            .stat-sublabel {
                color: #78909c;
                font-size: 0.7em;
                margin-top: 8px;
                font-weight: 500;
            }
            .critical { color: #ff1744; text-shadow: 0 0 20px rgba(255, 23, 68, 0.5); }
            .high { color: #ff6f00; text-shadow: 0 0 15px rgba(255, 111, 0, 0.5); }
            .safe { color: #00e676; text-shadow: 0 0 15px rgba(0, 230, 118, 0.5); }
            .neutral { color: #78909c; }
            
            .chart-section {
                background: linear-gradient(135deg, rgba(30, 30, 50, 0.95), rgba(20, 20, 40, 0.9));
                padding: 30px;
                border-radius: 12px;
                border: 1px solid rgba(239, 83, 80, 0.2);
                backdrop-filter: blur(10px);
                margin-bottom: 30px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            }
            .chart-header { margin-bottom: 20px; }
            .chart-title {
                font-size: 1.5em;
                font-weight: 700;
                color: #fff;
                letter-spacing: -0.5px;
            }
            .chart-container {
                position: relative;
                height: 350px;
            }
            .section {
                background: linear-gradient(135deg, rgba(30, 30, 50, 0.95), rgba(20, 20, 40, 0.9));
                padding: 30px;
                border-radius: 12px;
                border: 1px solid rgba(239, 83, 80, 0.2);
                backdrop-filter: blur(10px);
                margin-bottom: 30px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            }
            .section-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 25px;
                padding-bottom: 15px;
                border-bottom: 1px solid rgba(239, 83, 80, 0.2);
            }
            h2 {
                font-size: 1.5em;
                font-weight: 700;
                color: #fff;
                letter-spacing: -0.5px;
            }
            .section-count {
                background: rgba(239, 83, 80, 0.2);
                border: 1px solid rgba(239, 83, 80, 0.3);
                padding: 5px 15px;
                border-radius: 20px;
                font-size: 0.9em;
                font-weight: 700;
                color: #ff5252;
            }
            .alert {
                padding: 20px;
                margin: 15px 0;
                border-radius: 8px;
                border-left: 4px solid;
                background: rgba(30, 30, 50, 0.5);
                transition: all 0.3s ease;
            }
            .alert:hover {
                transform: translateX(5px);
                background: rgba(30, 30, 50, 0.7);
            }
            .alert-critical {
                border-color: #ff1744;
                background: linear-gradient(90deg, rgba(255, 23, 68, 0.1), transparent);
            }
            .alert-high {
                border-color: #ff6f00;
                background: linear-gradient(90deg, rgba(255, 111, 0, 0.1), transparent);
            }
            .alert-medium {
                border-color: #ffab00;
                background: linear-gradient(90deg, rgba(255, 171, 0, 0.1), transparent);
            }
            .alert-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 12px;
            }
            .alert-title {
                font-weight: 600;
                font-size: 1.05em;
                color: #fff;
                flex: 1;
            }
            .alert-details {
                color: #b0bec5;
                margin: 8px 0;
                font-size: 0.9em;
                line-height: 1.6;
            }
            .alert-meta {
                display: flex;
                gap: 20px;
                margin-top: 12px;
                padding-top: 12px;
                border-top: 1px solid rgba(255, 255, 255, 0.05);
            }
            .alert-meta-item {
                color: #78909c;
                font-size: 0.8em;
            }
            .badge {
                display: inline-block;
                padding: 4px 12px;
                border-radius: 4px;
                font-size: 0.7em;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            .badge-critical { background: #ff1744; color: white; }
            .badge-high { background: #ff6f00; color: white; }
            .badge-medium { background: #ffab00; color: black; }
            .badge-ddos { background: #ff1744; color: white; }
            .badge-nmap { background: #ff6f00; color: white; }
            .badge-arp { background: #ffab00; color: black; }
            .badge-mitm { background: #d500f9; color: white; }
            
            .device-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: rgba(30, 30, 50, 0.5);
                padding: 18px;
                margin: 12px 0;
                border-radius: 8px;
                border-left: 3px solid #ef5350;
                transition: all 0.3s ease;
            }
            .device-item:hover {
                transform: translateX(5px);
                background: rgba(30, 30, 50, 0.7);
                border-color: #ff1744;
            }
            .device-main { flex: 1; }
            .device-mac {
                font-family: 'SF Mono', monospace;
                font-weight: 700;
                color: #ff5252;
                font-size: 1em;
                margin-bottom: 8px;
            }
            .device-details {
                color: #b0bec5;
                font-size: 0.85em;
                display: flex;
                gap: 15px;
                flex-wrap: wrap;
            }
            .device-detail {
                display: flex;
                align-items: center;
                gap: 5px;
            }
            .status-badge {
                display: inline-block;
                padding: 10px 22px;
                border-radius: 6px;
                font-weight: 700;
                font-size: 1em;
                text-transform: uppercase;
                letter-spacing: 1px;
                font-family: 'SF Mono', monospace;
            }
            .status-safe {
                background: rgba(0, 230, 118, 0.15);
                color: #00e676;
                border: 2px solid #00e676;
                box-shadow: 0 0 20px rgba(0, 230, 118, 0.3);
            }
            .status-danger {
                background: rgba(255, 23, 68, 0.15);
                color: #ff1744;
                border: 2px solid #ff1744;
                box-shadow: 0 0 20px rgba(255, 23, 68, 0.3);
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0%, 100% { box-shadow: 0 0 20px rgba(255, 23, 68, 0.3); }
                50% { box-shadow: 0 0 30px rgba(255, 23, 68, 0.6); }
            }
            .refresh-btn {
                position: fixed;
                bottom: 30px; right: 30px;
                background: linear-gradient(135deg, #ff1744, #f50057);
                color: white;
                border: none;
                padding: 14px 28px;
                border-radius: 8px;
                font-size: 0.95em;
                font-weight: 700;
                cursor: pointer;
                box-shadow: 0 6px 20px rgba(255, 23, 68, 0.4);
                transition: all 0.3s ease;
                z-index: 1000;
                text-transform: uppercase;
                letter-spacing: 1px;
            }
            .refresh-btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 10px 30px rgba(255, 23, 68, 0.6);
            }
            .empty-state {
                text-align: center;
                padding: 60px 20px;
                color: #78909c;
            }
            .empty-state-title {
                color: #00e676;
                font-size: 1.5em;
                margin-bottom: 10px;
                font-weight: 700;
            }
            @media (max-width: 768px) {
                .stats-grid { grid-template-columns: repeat(3, 1fr); gap: 10px; }
                .stat-card { padding: 15px; }
                .stat-number { font-size: 2em; }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <div class="main-title">WIFI NETWORK SECURITY MONITOR</div>
                <div class="detection-list">
                    <span class="detection-badge">ARP Spoofing</span>
                    <span class="detection-badge">MAC Spoofing</span>
                    <span class="detection-badge">MITM Gateway</span>
                    <span class="detection-badge">DDoS Attack</span>
                    <span class="detection-badge">Nmap Scan</span>
                    <span class="detection-badge">Deauth Attack</span>
                    <span class="detection-badge">WiFi Sniffer</span>
                    <span class="detection-badge">Blacklist Detection</span>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Appareils</div>
                    <div class="stat-number safe">{{ total_devices }}</div>
                    <div class="stat-sublabel">Connect√©s</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Alertes</div>
                    <div class="stat-number {% if alert_count > 0 %}critical{% else %}safe{% endif %}">
                        {{ alert_count }}
                    </div>
                    <div class="stat-sublabel">Actives</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Trafic WiFi</div>
                    <div class="stat-number {% if network_packets > 10000 %}critical{% elif network_packets > 5000 %}high{% elif network_packets > 1000 %}high{% else %}safe{% endif %}">
                        {{ '{:,}'.format(network_packets) if network_packets > 0 else '0' }}
                    </div>
                    <div class="stat-sublabel">{{ '{:,}'.format(packets_per_sec) if packets_per_sec > 0 else '0' }} pkt/s</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">DDoS</div>
                    <div class="stat-number {% if ddos_count > 0 %}critical{% else %}neutral{% endif %}">
                        {{ ddos_count }}
                    </div>
                    <div class="stat-sublabel">D√©tect√©es</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Dernier Scan</div>
                    <div class="stat-number" style="font-size:1.2em; color:#ff5252;">
                        {{ last_scan.split()[1] if last_scan != 'Aucun' else '--:--:--' }}
                    </div>
                    <div class="stat-sublabel">Horodatage</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Status</div>
                    <div style="margin-top: 10px;">
                        <span class="status-badge {% if alert_count == 0 %}status-safe{% else %}status-danger{% endif %}">
                            {% if alert_count == 0 %}SECURE{% else %}THREAT{% endif %}
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="chart-section">
                <div class="chart-header">
                    <div class="chart-title">üìä ACTIVIT√â R√âSEAU EN TEMPS R√âEL</div>
                </div>
                <div class="chart-container">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>
            
            <div class="section">
                <div class="section-header">
                    <h2>ALERTES DE S√âCURIT√â</h2>
                    <span class="section-count">{{ alerts|length }}</span>
                </div>
                {% if alerts %}
                    {% for alert in alerts[-10:][::-1] %}
                    <div class="alert alert-{{ alert.severity|lower }}">
                        <div class="alert-header">
                            <div class="alert-title">{{ alert.description }}</div>
                            <div>
                                <span class="badge badge-{{ alert.severity|lower }}">{{ alert.severity }}</span>
                                {% if 'DDOS' in alert.type %}<span class="badge badge-ddos">DDoS</span>{% endif %}
                                {% if 'NMAP' in alert.type %}<span class="badge badge-nmap">Nmap</span>{% endif %}
                                {% if 'ARP' in alert.type or 'MAC' in alert.type %}<span class="badge badge-arp">ARP</span>{% endif %}
                                {% if 'MITM' in alert.type %}<span class="badge badge-mitm">MITM</span>{% endif %}
                            </div>
                        </div>
                        {% if alert.get('ip') or alert.get('mac') %}
                        <div class="alert-details">
                            {% if alert.get('ip') %}<strong>IP:</strong> {{ alert.ip }}{% endif %}
                            {% if alert.get('mac') %}{% if alert.get('ip') %} | {% endif %}<strong>MAC:</strong> {{ alert.mac }}{% endif %}
                        </div>
                        {% endif %}
                        {% if alert.get('details') %}<div class="alert-details">{{ alert.details }}</div>{% endif %}
                        <div class="alert-details"><strong>Recommandation:</strong> {{ alert.recommendation }}</div>
                        <div class="alert-meta">
                            <div class="alert-meta-item">{{ alert.timestamp }}</div>
                            <div class="alert-meta-item">TYPE: {{ alert.type }}</div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <div class="empty-state-title">SYST√àME S√âCURIS√â</div>
                        <p>Aucune menace d√©tect√©e sur le r√©seau</p>
                    </div>
                {% endif %}
            </div>
            
            <div class="section">
                <div class="section-header">
                    <h2>APPAREILS CONNECT√âS</h2>
                    <span class="section-count">{{ total_devices }}</span>
                </div>
                {% if devices %}
                    {% for mac, info in devices.items() %}
                    <div class="device-item">
                        <div class="device-main">
                            <div class="device-mac">{{ mac }}</div>
                            <div class="device-details">
                                <div class="device-detail"><strong>IP:</strong> {{ info.ips|join(', ') }}</div>
                                <div class="device-detail"><strong>Type:</strong> {{ info.type }}</div>
                                <div class="device-detail"><strong>Ports:</strong> {{ info.open_ports|length }}</div>
                                <div class="device-detail"><strong>Vu:</strong> {{ info.first_seen }}</div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state"><p>Aucun appareil d√©tect√©</p></div>
                {% endif %}
            </div>
            
            <button class="refresh-btn" onclick="location.reload()">ACTUALISER</button>
        </div>
        
        <script>
            const ctx = document.getElementById('activityChart').getContext('2d');
            const activityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Alertes de s√©curit√©',
                            data: [],
                            borderColor: '#ff1744',
                            backgroundColor: 'rgba(255, 23, 68, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: '#ff1744',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Appareils connect√©s',
                            data: [],
                            borderColor: '#00e676',
                            backgroundColor: 'rgba(0, 230, 118, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: '#00e676',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#fff',
                                font: { size: 14, family: "'Inter', sans-serif", weight: 600 },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(30, 30, 50, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#ef5350',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)', borderColor: 'rgba(239, 83, 80, 0.3)' },
                            ticks: { color: '#b0bec5', font: { size: 11 }, maxRotation: 45, minRotation: 45 }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.05)', borderColor: 'rgba(239, 83, 80, 0.3)' },
                            ticks: {
                                color: '#ff5252',
                                font: { size: 11, weight: 600 },
                                callback: function(value) { return Math.floor(value); }
                            },
                            title: { display: true, text: 'Alertes', color: '#ff5252', font: { size: 12, weight: 700 } }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            grid: { drawOnChartArea: false },
                            ticks: {
                                color: '#00e676',
                                font: { size: 11, weight: 600 },
                                callback: function(value) { return Math.floor(value); }
                            },
                            title: { display: true, text: 'Appareils', color: '#00e676', font: { size: 12, weight: 700 } }
                        }
                    },
                    animation: { duration: 750, easing: 'easeInOutQuart' }
                }
            });
            
            async function loadActivityData() {
                try {
                    const response = await fetch('/api/activity');
                    const data = await response.json();
                    if (data.alerts && data.alerts.length > 0) {
                        const labels = data.alerts.map(item => item.timestamp.split(' ')[1]);
                        const alertValues = data.alerts.map(item => item.count);
                        const deviceValues = data.devices.map(item => item.count);
                        activityChart.data.labels = labels;
                        activityChart.data.datasets[0].data = alertValues;
                        activityChart.data.datasets[1].data = deviceValues;
                        activityChart.update('none');
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                }
            }
            
            loadActivityData();
            setInterval(loadActivityData, 10000);
            setTimeout(() => location.reload(), 300000);
        </script>
    </body>
    </html>
    """
    
    last_scan = scan_history[-1]['timestamp'] if scan_history else 'Aucun'
    ddos_count = len([a for a in alerts if 'DDOS' in a.get('type', '')])
    nmap_count = len([a for a in alerts if 'NMAP' in a.get('type', '')])
    
    return render_template_string(
        html,
        alerts=alerts,
        devices=devices_database,
        total_devices=len(devices_database),
        alert_count=len([a for a in alerts if a.get('severity') in ['CRITICAL', 'HIGH']]),
        ddos_count=ddos_count,
        nmap_count=nmap_count,
        last_scan=last_scan,
        network_packets=network_packets,
        packets_per_sec=packets_per_sec
    )

@app.route('/api/stats')
def get_stats():
    """API pour obtenir les statistiques"""
    return jsonify({
        'total_scans': len(scan_history),
        'total_devices': len(devices_database),
        'total_alerts': len(alerts),
        'attack_types': dict(attack_stats),
        'recent_alerts': alerts[-10:] if alerts else []
    })

@app.route('/api/clear_alerts', methods=['POST'])
def clear_alerts():
    """Efface toutes les alertes"""
    global alerts
    alerts = []
    return jsonify({'status': 'success', 'message': 'Alertes effac√©es'})

if __name__ == '__main__':
    print("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó")
    print("‚ïë  üõ°Ô∏è  WiFi Attack Detection Server     ‚ïë")
    print("‚ïë  http://192.168.1.249:5000            ‚ïë")
    print("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n")
    print("‚úÖ Serveur d√©marr√©!")
    print("üì° D√©tections actives:")
    print("   - ARP Spoofing")
    print("   - MAC Spoofing")
    print("   - MITM Gateway")
    print("   - Deauth Attack")
    print("   - DDoS Attack (WiFi Sniffer)")
    print("   - Nmap Scan")
    print("\nüìä Graphique: Alertes + Appareils")
    print("üî• Sniffer WiFi: Capture de paquets en temps r√©el")
    print("\n‚öôÔ∏è Seuils DDoS (pour tests):")
    print("   - > 10,000 paquets = CRITICAL üö®")
    print("   - > 5,000 paquets = HIGH ‚ö†Ô∏è")
    print("   - > 1,000 paquets = MEDIUM ‚ÑπÔ∏è")
    print("   - < 1,000 paquets = Normal ‚úÖ")
    print("\nüîç En attente de donn√©es ESP8266...\n")
    
    app.run(host='0.0.0.0', port=5000, debug=True)
